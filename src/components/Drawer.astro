---
// import ThemeSwitch from "@components/ThemeSwitch.astro";
import ThemeSwitch from "@components/ThemeSwitch";
import { getUser } from "@lib/auth";
import { getProfileInfo } from "@lib/db";
import { ChevronRight, LogOut, Settings } from "lucide-astro";

const token = Astro.cookies.has("sbat")
  ? Astro.cookies.get("sbat").value
  : null;

let profile = null;

if (token) {
  const { id } = await getUser(token);
  const user = await getProfileInfo(id);

  profile = {
    id: user.id,
    username: user.username.toLowerCase(),
    full_name: user.full_name,
    status: user.status,
    initials: user.full_name
      .split(" ")
      .map((n) => n[0])
      .join("")
      .toLocaleLowerCase(),
  };
}

let activeJs = false;
if (profile) {
  activeJs = true;
}
---

{
  profile ? (
    <div class="drawer" id="drawer">
      <input type="checkbox" class="drawer-toggle" id="sidebar" />
      <div class="drawer-content flex flex-col transition-transform duration-300 ease-in-out">
        <main class="mx-auto w-4/5">
          <slot />
        </main>
      </div>
      <div class="drawer-side">
        <label
          for="sidebar"
          aria-label="close sidebar"
          class="drawer-overlay"
        />
        <ul class="menu min-h-full w-80 overflow-y-auto border-opacity-50 bg-base-200 p-4 font-sora text-base-content shadow-lg">
          <h2 class="menu-title flex items-center gap-4 px-1.5 font-syne text-lg text-blue-500">
            General
          </h2>
          <div class="active-primary">
            <li>
              <a href="/home">
                <ChevronRight />
                <span>Inicio</span>
              </a>
            </li>
            <li>
              <a href="/explore">
                <ChevronRight />
                <span>Explorar Intercambios</span>
              </a>
            </li>
            <li>
              <a href="/exchanges">
                <ChevronRight />
                <span>Mis Articulos</span>
              </a>
            </li>
            <li>
              <a>
                <ChevronRight />
                Mensajes
              </a>
            </li>
          </div>
          <div class="divider" />
          <h2 class="menu-title flex items-center gap-4 px-1.5 font-syne text-lg text-current brightness-150">
            Cuenta
          </h2>
          <li>
            <a>
              <Settings className="font-normal" />
              Configuración
            </a>
          </li>
          <li>
            <a>
              <LogOut className="font-normal" />
              Cerrar Sesión
            </a>
          </li>
          <li>
            <ThemeSwitch client:load />
          </li>
          <div class="divider" />
          <div class="h-full">
            <li>
              <div class="avatar placeholder">
                <div class="flex h-10 w-10 items-center justify-center rounded-full  bg-primary">
                  <span class="text-sm">{profile.initials}</span>
                </div>
                <span>
                  <div class="flex flex-col">
                    <p class="capitalize text-current brightness-200">
                      {profile.full_name}
                    </p>
                    <p class="capitalize text-neutral">@{profile.username}</p>
                  </div>
                </span>
              </div>
            </li>
          </div>
        </ul>
      </div>
    </div>
  ) : (
    <div class="drawer-content flex transform flex-col transition-transform duration-300 ease-in-out">
      <main>
        <slot />
      </main>
    </div>
  )
}

<style>
  .drawer-side {
    top: 60px;
  }
</style>

<script is:inline define:vars={{ activeJs }}>
  function setupDrawer(activeJs) {
    if (!activeJs) return;
    const drawer = document.getElementById("drawer");
    const checkbox = document.getElementById("toggleMenu");

    function toggleSidebar(status) {
      drawer.classList.toggle("drawer-open", status);
    }

    function setActiveLink() {
      const currentPath = window.location.pathname;
      const links = document.querySelectorAll(".menu a");

      links.forEach((link) => {
        const linkPath = link.getAttribute("href");

        if (linkPath && currentPath.includes(linkPath)) {
          link.classList.add("active");
        } else {
          link.classList.remove("active");
        }
      });
    }

    // Agrega la clase 'active' al cargar la página
    setActiveLink();

    checkbox.addEventListener("change", function (e) {
      toggleSidebar(e.target.checked);
    });

    // Actualiza la clase 'active' al cambiar la ruta
    window.addEventListener("popstate", setActiveLink);
  }

  document.addEventListener("DOMContentLoaded", function () {
    setupDrawer(activeJs);
  });
</script>
