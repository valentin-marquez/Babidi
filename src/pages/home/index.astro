---
import CarouselItems from "@app/CarouselItems";
import HomeLayout from "@layouts/HomeLayout.astro";
import { getUser } from "@lib/auth";
import { getCategories, getProfileInfo } from "@lib/db";

const token = Astro.cookies.has("sbat")
  ? Astro.cookies.get("sbat").value
  : null;
if (token === null) {
  return Astro.redirect("/login");
}

const { id } = await getUser(token);
const user = await getProfileInfo(id);

if (user === null) {
  return Astro.redirect("/login");
}

const profile = {
  id: user.id,
  username: user.username,
  full_name: user.full_name,
  status: user.status,
  initials: user.full_name
    .split(" ")
    .map((n) => n[0])
    .join(""),
};
const categories = await getCategories();
---

<HomeLayout profile={profile}>
  <CarouselItems categories={categories} client:load />

  <script id="initvars" define:vars={{ profile, categories, id }}>
    let profileJson = JSON.stringify({ profile });
    let categoriesJson = JSON.stringify({ categories });
    localStorage.setItem("categories", categoriesJson);
    localStorage.setItem("profile", profileJson);
    localStorage.setItem("clientid", id);
    document.getElementById("initvars").remove();
  </script>
</HomeLayout>
